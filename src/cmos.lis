cmos.asm:
     1                          ;	TITLE	BBC BASIC (C) R.T.RUSSELL 1984-2024
     2                          ;
     3                          ;PATCH FOR BBC BASIC TO CP/M 2.2 & 3.0
     4                          ;*    PLAIN VANILLA CP/M VERSION     *
     5                          ;(C) COPYRIGHT R.T.RUSSELL, 25-12-1986
     6                          ;VERSION 5.0, 25-05-2024
     7                          ;
     8                          	PUBLIC	OSINIT
     9                          	PUBLIC	OSRDCH
    10                          	PUBLIC	OSWRCH
    11                          	PUBLIC	OSLINE
    12                          	PUBLIC	OSSAVE
    13                          	PUBLIC	OSLOAD
    14                          	PUBLIC	OSOPEN
    15                          	PUBLIC	OSSHUT
    16                          	PUBLIC	OSBGET
    17                          	PUBLIC	OSBPUT
    18                          	PUBLIC	OSSTAT
    19                          	PUBLIC	GETEXT
    20                          	PUBLIC	GETPTR
    21                          	PUBLIC	PUTPTR
    22                          	PUBLIC	PROMPT
    23                          	PUBLIC	RESET
    24                          	PUBLIC	LTRAP
    25                          	PUBLIC	OSCLI
    26                          	PUBLIC	TRAP
    27                          	PUBLIC	OSKEY
    28                          	PUBLIC	OSCALL
    29                          ;
    30                          	EXTERN	BYE
    31                          	EXTERN	GETKEY
    32                          ;
    33                          	EXTERN	ESCAPE
    34                          	EXTERN	EXTERR
    35                          	EXTERN	CHECK
    36                          	EXTERN	CRLF
    37                          ;
    38                          	EXTERN	ACCS
    39                          	EXTERN	FREE
    40                          	EXTERN	HIMEM
    41                          	EXTERN	CURLIN
    42                          	EXTERN	AUTONO
    43                          	EXTERN	USER
    44                          	EXTERN	VERMSG
    45                          ;
    46                          ;
    47                          ;OSSAVE - Save an area of memory to a file.
    48                          ;   Inputs: HL addresses filename (term CR)
    49                          ;           DE = start address of data to save
    50                          ;           BC = length of data to save (bytes)
    51                          ; Destroys: A,B,C,D,E,H,L,F
    52                          ;
    53  0000  cd6d04            STSAVE:	CALL	SAVLOD		;*SAVE
    54  0003  da3b04            	JP	C,HUH		;"Bad command"
    55  0006  e5                	PUSH	HL
    56  0007  1804              	JR	OSS1
    57                          ;
    58  0009  c5                OSSAVE:	PUSH	BC		;SAVE
    59  000a  cdd402            	CALL	SETUP0
    60  000d  eb                OSS1:	EX	DE,HL
    61  000e  cd6a02            	CALL	CREATE
    62  0011  2014              	JR	NZ,SAVE
    63  0013  3ebe              DIRFUL:	LD	A,190
    64  0015  cd0000            	CALL	EXTERR
    65  0018  4469726563746f72  	DEFM	"Directory full"
              792066756c6c      
    66  0026  00                	DEFB	0
    67  0027  cd3c02            SAVE:	CALL	WRITE
    68  002a  09                	ADD	HL,BC
    69  002b  e3                	EX	(SP),HL
    70  002c  ed42              	SBC	HL,BC
    71  002e  e3                	EX	(SP),HL
    72  002f  2802              	JR	Z,SAVE1
    73  0031  30f4              	JR	NC,SAVE
    74  0033  c1                SAVE1:	POP	BC
    75  0034  3e10              CLOSE:	LD	A,16
    76  0036  cd1002            	CALL	BDOS1
    77  0039  3c                	INC	A
    78  003a  c0                	RET	NZ
    79  003b  3ec8              	LD	A,200
    80  003d  cd0000            	CALL	EXTERR
    81  0040  436c6f7365206572  	DEFM	"Close error"
              726f72            
    82  004b  00                	DEFB	0
    83                          ;
    84                          ;OSSHUT - Close disk file(s).
    85                          ;   Inputs: E = file channel
    86                          ;           If E=0 all files are closed (except SPOOL)
    87                          ; Destroys: A,B,C,D,E,H,L,F
    88                          ;
    89  004c  7b                OSSHUT:	LD	A,E
    90  004d  b7                	OR	A
    91  004e  200b              	JR	NZ,SHUTIT
    92  0050  1c                SHUT0:	INC	E
    93  0051  cb5b              	BIT	3,E
    94  0053  c0                	RET	NZ
    95  0054  d5                	PUSH	DE
    96  0055  cd6c00            	CALL	SHUT1
    97  0058  d1                	POP	DE
    98  0059  18f5              	JR	SHUT0
    99                          ;
   100  005b  cdc302            SHUTIT:	CALL	FIND1
   101  005e  2010              	JR	NZ,SHUT2
   102  0060  c3ae02            	JP	CHANER
   103                          ;
   104  0063  216b08            SESHUT:	LD	HL,FLAGS
   105  0066  cb86              	RES	0,(HL)		;STOP EXEC
   106  0068  cb8e              	RES	1,(HL)		;STOP SPOOL
   107  006a  1e08              	LD	E,8		;SPOOL/EXEC CHANNEL
   108  006c  cdc302            SHUT1:	CALL	FIND1
   109  006f  c8                	RET	Z
   110  0070  af                SHUT2:	XOR	A
   111  0071  77                	LD	(HL),A
   112  0072  2b                	DEC	HL
   113  0073  77                	LD	(HL),A
   114  0074  212500            	LD	HL,37
   115  0077  19                	ADD	HL,DE
   116  0078  cb7e              	BIT	7,(HL)
   117  007a  23                	INC	HL
   118  007b  c43c02            	CALL	NZ,WRITE
   119  007e  21a600            	LD	HL,FCBSIZ
   120  0081  19                	ADD	HL,DE
   121  0082  ed4b0000          	LD	BC,(FREE)
   122  0086  ed42              	SBC	HL,BC
   123  0088  20aa              	JR	NZ,CLOSE
   124  008a  ed530000          	LD	(FREE),DE	;RELEASE SPACE
   125  008e  18a4              	JR	CLOSE
   126                          ;
   127                          ;TYPE - *TYPE command.
   128                          ;Types file to console output.
   129                          ;
   130  0090  37                TYPE:	SCF			;*TYPE
   131  0091  cdf600            	CALL	OSOPEN
   132  0094  b7                	OR	A
   133  0095  2828              	JR	Z,NOTFND
   134  0097  5f                	LD	E,A
   135  0098  3a6b08            TYPE1:	LD	A,(FLAGS)	;TEST
   136  009b  cb7f              	BIT	7,A		;FOR
   137  009d  200a              	JR	NZ,TYPESC	;ESCape
   138  009f  cd6201            	CALL	OSBGET
   139  00a2  cd9b06            	CALL	OSWRCH		;N.B. CALLS "TEST"
   140  00a5  30f1              	JR	NC,TYPE1
   141  00a7  18a3              	JR	OSSHUT
   142                          ;
   143  00a9  cd4c00            TYPESC:	CALL	OSSHUT		;CLOSE!
   144  00ac  c31b06            	JP	ABORT
   145                          ;
   146                          ;OSLOAD - Load an area of memory from a file.
   147                          ;   Inputs: HL addresses filename (term CR)
   148                          ;           DE = address at which to load
   149                          ;           BC = maximum allowed size (bytes)
   150                          ;  Outputs: Carry reset indicates no room for file.
   151                          ; Destroys: A,B,C,D,E,H,L,F
   152                          ;
   153  00af  cd6d04            STLOAD:	CALL	SAVLOD		;*LOAD
   154  00b2  e5                	PUSH	HL
   155  00b3  1804              	JR	OSL1
   156                          ;
   157  00b5  c5                OSLOAD:	PUSH	BC		;LOAD
   158  00b6  cdd402            	CALL	SETUP0
   159  00b9  eb                OSL1:	EX	DE,HL
   160  00ba  cd6002            	CALL	OPEN
   161  00bd  201d              	JR	NZ,LOAD0
   162  00bf  3ed6              NOTFND:	LD	A,214
   163  00c1  cd0000            	CALL	EXTERR
   164  00c4  46696c65206e6f74  	DEFM	"File not found"
              20666f756e64      
   165  00d2  00                	DEFB	0
   166  00d3  cd0b02            LOAD:	CALL	READ
   167  00d6  200a              	JR	NZ,LOAD1
   168  00d8  cd5502            	CALL	INCSEC
   169  00db  09                	ADD	HL,BC
   170  00dc  e3                LOAD0:	EX	(SP),HL
   171  00dd  ed42              	SBC	HL,BC
   172  00df  e3                	EX	(SP),HL
   173  00e0  30f1              	JR	NC,LOAD
   174  00e2  c1                LOAD1:	POP	BC
   175  00e3  f5                	PUSH	AF
   176  00e4  cd3400            	CALL	CLOSE
   177  00e7  f1                	POP	AF
   178  00e8  3f                	CCF
   179  00e9  c9                OSCALL:	RET
   180                          ;
   181                          ;OSOPEN - Open a file for reading or writing.
   182                          ;   Inputs: HL addresses filename (term CR)
   183                          ;           Carry set for OPENIN, cleared for OPENOUT.
   184                          ;  Outputs: A = file channel (=0 if cannot open)
   185                          ;           DE = file FCB
   186                          ; Destroys: A,B,C,D,E,H,L,F
   187                          ;
   188  00ea  f5                OPENIT:	PUSH	AF		;SAVE CARRY
   189  00eb  cdd402            	CALL	SETUP0
   190  00ee  f1                	POP	AF
   191  00ef  d46a02            	CALL	NC,CREATE
   192  00f2  dc6002            	CALL	C,OPEN
   193  00f5  c9                	RET
   194                          ;
   195  00f6  cdea00            OSOPEN:	CALL	OPENIT
   196  00f9  c8                	RET	Z		;ERROR
   197  00fa  0607              	LD	B,7		;MAX. NUMBER OF FILES
   198  00fc  216a08            	LD	HL,TABLE+15
   199  00ff  7e                OPEN1:	LD	A,(HL)
   200  0100  2b                	DEC	HL
   201  0101  b6                	OR	(HL)
   202  0102  281c              	JR	Z,OPEN2		;FREE CHANNEL
   203  0104  2b                	DEC	HL
   204  0105  10f8              	DJNZ	OPEN1
   205  0107  3ec0              	LD	A,192
   206  0109  cd0000            	CALL	EXTERR
   207  010c  546f6f206d616e79  	DEFM	"Too many open files"
              206f70656e206669  
              6c6573            
   208  011f  00                	DEFB	0
   209                          ;
   210  0120  ed5b0000          OPEN2:	LD	DE,(FREE)	;FREE SPACE POINTER
   211  0124  73                	LD	(HL),E
   212  0125  23                	INC	HL
   213  0126  72                	LD	(HL),D
   214  0127  78                	LD	A,B		;CHANNEL (1-7)
   215  0128  21a600            	LD	HL,FCBSIZ
   216  012b  19                	ADD	HL,DE		;RESERVE SPACE
   217  012c  220000            	LD	(FREE),HL
   218  012f  215c00            OPEN3:	LD	HL,FCB		;ENTRY FROM SPOOL/EXEC
   219  0132  d5                	PUSH	DE
   220  0133  012400            	LD	BC,36
   221  0136  edb0              	LDIR			;COPY FCB
   222  0138  eb                	EX	DE,HL
   223  0139  23                	INC	HL
   224  013a  71                	LD	(HL),C		;CLEAR PTR
   225  013b  23                	INC	HL
   226  013c  d1                	POP	DE
   227  013d  47                	LD	B,A
   228  013e  cdeb01            	CALL	RDF		;READ OR FILL
   229  0141  78                	LD	A,B
   230  0142  c30000            	JP	CHECK
   231                          ;
   232                          ;OSBPUT - Write a byte to a random disk file.
   233                          ;   Inputs: E = file channel
   234                          ;           A = byte to write
   235                          ; Destroys: A,B,C,F
   236                          ;
   237  0145  d5                OSBPUT:	PUSH	DE
   238  0146  e5                	PUSH	HL
   239  0147  47                	LD	B,A
   240  0148  cda202            	CALL	FIND
   241  014b  78                	LD	A,B
   242  014c  0600              	LD	B,0
   243  014e  2b                	DEC	HL
   244  014f  70                	LD	(HL),B		;CLEAR EOF
   245  0150  23                	INC	HL
   246  0151  4e                	LD	C,(HL)
   247  0152  cbb9              	RES	7,C
   248  0154  cbfe              	SET	7,(HL)
   249  0156  34                	INC	(HL)
   250  0157  23                	INC	HL
   251  0158  e5                	PUSH	HL
   252  0159  09                	ADD	HL,BC
   253  015a  77                	LD	(HL),A
   254  015b  e1                	POP	HL
   255  015c  cce801            	CALL	Z,WRRDF		;WRITE THEN READ/FILL
   256  015f  e1                	POP	HL
   257  0160  d1                	POP	DE
   258  0161  c9                	RET
   259                          ;
   260                          ;OSBGET - Read a byte from a random disk file.
   261                          ;   Inputs: E = file channel
   262                          ;  Outputs: A = byte read
   263                          ;           Carry set if LAST BYTE of file
   264                          ; Destroys: A,B,C,F
   265                          ;
   266  0162  d5                OSBGET:	PUSH	DE
   267  0163  e5                	PUSH	HL
   268  0164  cda202            	CALL	FIND
   269  0167  4e                	LD	C,(HL)
   270  0168  cbb9              	RES	7,C
   271  016a  34                	INC	(HL)
   272  016b  23                	INC	HL
   273  016c  e5                	PUSH	HL
   274  016d  0600              	LD	B,0
   275  016f  09                	ADD	HL,BC
   276  0170  46                	LD	B,(HL)
   277  0171  e1                	POP	HL
   278  0172  ec0302            	CALL	PE,INCRDF	;INC SECTOR THEN READ
   279  0175  cce801            	CALL	Z,WRRDF		;WRITE THEN READ/FILL
   280  0178  78                	LD	A,B
   281  0179  e1                	POP	HL
   282  017a  d1                	POP	DE
   283  017b  c9                	RET
   284                          ;
   285                          ;OSSTAT - Read file status.
   286                          ;   Inputs: E = file channel
   287                          ;  Outputs: Z flag set - EOF
   288                          ;           (If Z then A=0)
   289                          ;           DE = address of file block.
   290                          ; Destroys: A,D,E,H,L,F
   291                          ;
   292  017c  cda202            OSSTAT:	CALL	FIND
   293  017f  2b                	DEC	HL
   294  0180  7e                	LD	A,(HL)
   295  0181  3c                	INC	A
   296  0182  c9                	RET
   297                          ;
   298                          ;GETEXT - Find file size.
   299                          ;   Inputs: E = file channel
   300                          ;  Outputs: DEHL = file size (0-&800000)
   301                          ; Destroys: A,B,C,D,E,H,L,F
   302                          ;
   303  0183  cda202            GETEXT:	CALL	FIND
   304  0186  eb                	EX	DE,HL
   305  0187  115c00            	LD	DE,FCB
   306  018a  012400            	LD	BC,36
   307  018d  d5                	PUSH	DE
   308  018e  edb0              	LDIR			;COPY FCB
   309  0190  eb                	EX	DE,HL
   310  0191  e3                	EX	(SP),HL
   311  0192  eb                	EX	DE,HL
   312  0193  3e23              	LD	A,35
   313  0195  cd1002            	CALL	BDOS1		;COMPUTE SIZE
   314  0198  e1                	POP	HL
   315  0199  af                	XOR	A
   316  019a  1806              	JR	GETPT1
   317                          ;
   318                          ;GETPTR - Return file pointer.
   319                          ;   Inputs: E = file channel
   320                          ;  Outputs: DEHL = pointer (0-&7FFFFF)
   321                          ; Destroys: A,B,C,D,E,H,L,F
   322                          ;
   323  019c  cda202            GETPTR:	CALL	FIND
   324  019f  7e                	LD	A,(HL)
   325  01a0  87                	ADD	A,A
   326  01a1  2b                	DEC	HL
   327  01a2  2b                GETPT1:	DEC	HL
   328  01a3  56                	LD	D,(HL)
   329  01a4  2b                	DEC	HL
   330  01a5  5e                	LD	E,(HL)
   331  01a6  2b                	DEC	HL
   332  01a7  66                	LD	H,(HL)
   333  01a8  6f                	LD	L,A
   334  01a9  cb3a              	SRL	D
   335  01ab  cb1b              	RR	E
   336  01ad  cb1c              	RR	H
   337  01af  cb1d              	RR	L
   338  01b1  c9                	RET
   339                          ;
   340                          ;PUTPTR - Update file pointer.
   341                          ;   Inputs: A = file channel
   342                          ;           DEHL = new pointer (0-&7FFFFF)
   343                          ; Destroys: A,B,C,D,E,H,L,F
   344                          ;
   345  01b2  55                PUTPTR:	LD	D,L
   346  01b3  29                	ADD	HL,HL
   347  01b4  cb13              	RL	E
   348  01b6  43                	LD	B,E
   349  01b7  4c                	LD	C,H
   350  01b8  5f                	LD	E,A		;CHANNEL
   351  01b9  d5                	PUSH	DE
   352  01ba  cda202            	CALL	FIND
   353  01bd  f1                	POP	AF
   354  01be  e67f              	AND	7FH
   355  01c0  cb7e              	BIT	7,(HL)		;PENDING WRITE?
   356  01c2  2802              	JR	Z,PUTPT1
   357  01c4  f680              	OR	80H
   358  01c6  77                PUTPT1:	LD	(HL),A
   359  01c7  d5                	PUSH	DE
   360  01c8  e5                	PUSH	HL
   361  01c9  2b                	DEC	HL
   362  01ca  2b                	DEC	HL
   363  01cb  2b                	DEC	HL
   364  01cc  56                	LD	D,(HL)
   365  01cd  2b                	DEC	HL
   366  01ce  5e                	LD	E,(HL)
   367  01cf  eb                	EX	DE,HL
   368  01d0  b7                	OR	A
   369  01d1  ed42              	SBC	HL,BC
   370  01d3  e1                	POP	HL
   371  01d4  d1                	POP	DE
   372  01d5  c8                	RET	Z
   373  01d6  23                	INC	HL
   374  01d7  b7                	OR	A
   375  01d8  fc3c02            	CALL	M,WRITE
   376  01db  e5                	PUSH	HL
   377  01dc  2b                	DEC	HL
   378  01dd  2b                	DEC	HL
   379  01de  2b                	DEC	HL
   380  01df  3600              	LD	(HL),0
   381  01e1  2b                	DEC	HL
   382  01e2  70                	LD	(HL),B
   383  01e3  2b                	DEC	HL
   384  01e4  71                	LD	(HL),C		;NEW RECORD NO.
   385  01e5  e1                	POP	HL
   386  01e6  1803              	JR	RDF
   387                          ;
   388                          ;WRRDF - Write, read; if EOF fill with zeroes.
   389                          ;RDF - Read; if EOF fill with zeroes.
   390                          ;   Inputs: DE address FCB.
   391                          ;           HL addresses data buffer.
   392                          ;  Outputs: A=0, Z-flag set.
   393                          ;           Carry set if fill done (EOF)
   394                          ; Destroys: A,H,L,F
   395                          ;
   396  01e8  cd3c02            WRRDF:	CALL	WRITE
   397  01eb  cd0b02            RDF:	CALL	READ
   398  01ee  2b                	DEC	HL
   399  01ef  cbbe              	RES	7,(HL)
   400  01f1  2b                	DEC	HL
   401  01f2  77                	LD	(HL),A		;CLEAR EOF FLAG
   402  01f3  c8                	RET	Z
   403  01f4  36ff              	LD	(HL),-1		;SET EOF FLAG
   404  01f6  23                	INC	HL
   405  01f7  23                	INC	HL
   406  01f8  c5                	PUSH	BC
   407  01f9  af                	XOR	A
   408  01fa  0680              	LD	B,128
   409  01fc  77                FILL:	LD	(HL),A
   410  01fd  23                	INC	HL
   411  01fe  10fc              	DJNZ	FILL
   412  0200  c1                	POP	BC
   413  0201  37                	SCF
   414  0202  c9                	RET
   415                          ;
   416                          ;INCRDF - Increment record, read; if EOF fill.
   417                          ;   Inputs: DE addresses FCB.
   418                          ;           HL addresses data buffer.
   419                          ;  Outputs: A=1, Z-flag reset.
   420                          ;           Carry set if fill done (EOF)
   421                          ; Destroys: A,H,L,F
   422                          ;
   423  0203  cd5502            INCRDF:	CALL	INCSEC
   424  0206  cdeb01            	CALL	RDF
   425  0209  3c                	INC	A
   426  020a  c9                	RET
   427                          ;
   428                          ;READ - Read a record from a disk file.
   429                          ;   Inputs: DE addresses FCB.
   430                          ;           HL = address to store data.
   431                          ;  Outputs: A<>0 & Z-flag reset indicates EOF.
   432                          ;           Carry = 0
   433                          ; Destroys: A,F
   434                          ;
   435                          ;BDOS1 - CP/M BDOS call.
   436                          ;   Inputs: A = function number
   437                          ;          DE = parameter
   438                          ;  Outputs: AF = result (carry=0)
   439                          ; Destroys: A,F
   440                          ;
   441  020b  cd9a02            READ:	CALL	SETDMA
   442  020e  3e21              	LD	A,33
   443  0210  cd2702            BDOS1:	CALL	BDOS0
   444  0213  2002              	JR	NZ,CPMERR
   445  0215  b7                	OR	A
   446  0216  c9                	RET
   447  0217  3eff              CPMERR:	LD	A,255
   448  0219  cd0000            	CALL	EXTERR
   449  021c  43502f4d20457272  	DEFM	"CP/M Error"
              6f72              
   450  0226  00                	DEFB	0
   451                          ;
   452  0227  c5                BDOS0:	PUSH	BC
   453  0228  d5                	PUSH	DE
   454  0229  e5                	PUSH	HL
   455  022a  dde5              	PUSH	IX
   456  022c  fde5              	PUSH	IY
   457  022e  4f                	LD	C,A
   458  022f  cd0500            	CALL	BDOS
   459  0232  24                	INC	H
   460  0233  25                	DEC	H
   461  0234  fde1              	POP	IY
   462  0236  dde1              	POP	IX
   463  0238  e1                	POP	HL
   464  0239  d1                	POP	DE
   465  023a  c1                	POP	BC
   466  023b  c9                	RET
   467                          ;
   468                          ;WRITE - Write a record to a disk file.
   469                          ;   Inputs: DE addresses FCB.
   470                          ;           HL = address to get data.
   471                          ; Destroys: A,F
   472                          ;
   473  023c  cd9a02            WRITE:	CALL	SETDMA
   474  023f  3e28              	LD	A,40
   475  0241  cd1002            	CALL	BDOS1
   476  0244  280f              	JR	Z,INCSEC
   477  0246  3ec6              	LD	A,198
   478  0248  cd0000            	CALL	EXTERR
   479  024b  4469736b2066756c  	DEFM	"Disk full"
              6c                
   480  0254  00                	DEFB	0
   481                          ;
   482                          ;INCSEC - Increment random record number.
   483                          ;   Inputs: DE addresses FCB.
   484                          ; Destroys: F
   485                          ;
   486  0255  e5                INCSEC:	PUSH	HL
   487  0256  212100            	LD	HL,33
   488  0259  19                	ADD	HL,DE
   489  025a  34                INCS1:	INC	(HL)
   490  025b  23                	INC	HL
   491  025c  28fc              	JR	Z,INCS1
   492  025e  e1                	POP	HL
   493  025f  c9                	RET
   494                          ;
   495                          ;OPEN - Open a file for access.
   496                          ;   Inputs: FCB set up.
   497                          ;  Outputs: DE = FCB
   498                          ;           A=0 & Z-flag set indicates Not Found.
   499                          ;           Carry = 0
   500                          ; Destroys: A,D,E,F
   501                          ;
   502  0260  115c00            OPEN:	LD	DE,FCB
   503  0263  3e0f              	LD	A,15
   504  0265  cd1002            	CALL	BDOS1
   505  0268  3c                	INC	A
   506  0269  c9                	RET
   507                          ;
   508                          ;CREATE - Create a disk file for writing.
   509                          ;   Inputs: FCB set up.
   510                          ;  Outputs: DE = FCB
   511                          ;           A=0 & Z-flag set indicates directory full.
   512                          ;           Carry = 0
   513                          ; Destroys: A,D,E,F
   514                          ;
   515  026a  cd7c02            CREATE:	CALL	CHKAMB
   516  026d  115c00            	LD	DE,FCB
   517  0270  3e13              	LD	A,19
   518  0272  cd1002            	CALL	BDOS1		;DELETE
   519  0275  3e16              	LD	A,22
   520  0277  cd1002            	CALL	BDOS1		;MAKE
   521  027a  3c                	INC	A
   522  027b  c9                	RET
   523                          ;
   524                          ;CHKAMB - Check for ambiguous filename.
   525                          ; Destroys: A,D,E,F
   526                          ;
   527  027c  c5                CHKAMB:	PUSH	BC
   528  027d  115c00            	LD	DE,FCB
   529  0280  060c              	LD	B,12
   530  0282  1a                CHKAM1:	LD	A,(DE)
   531  0283  fe3f              	CP	'?'
   532  0285  2805              	JR	Z,AMBIG		;AMBIGUOUS
   533  0287  13                	INC	DE
   534  0288  10f8              	DJNZ	CHKAM1
   535  028a  c1                	POP	BC
   536  028b  c9                	RET
   537  028c  3ecc              AMBIG:	LD	A,204
   538  028e  cd0000            	CALL	EXTERR
   539  0291  426164206e616d65  	DEFM	"Bad name"
   540  0299  00                	DEFB	0
   541                          ;
   542                          ;SETDMA - Set "DMA" address.
   543                          ;   Inputs: HL = address
   544                          ; Destroys: A,F
   545                          ;
   546  029a  3e1a              SETDMA:	LD	A,26
   547  029c  eb                	EX	DE,HL
   548  029d  cd2702            	CALL	BDOS0
   549  02a0  eb                	EX	DE,HL
   550  02a1  c9                	RET
   551                          ;
   552                          ;FIND - Find file parameters from channel.
   553                          ;   Inputs: E = channel
   554                          ;  Outputs: DE addresses FCB
   555                          ;           HL addresses pointer byte (FCB+37)
   556                          ; Destroys: A,D,E,H,L,F
   557                          ;
   558  02a2  1c                FIND:	INC	E		;N.B. channel 8 is SPOOL/EXEC
   559  02a3  1d                	DEC	E
   560  02a4  2808              	JR	Z,CHANER
   561  02a6  cdc302            	CALL	FIND1
   562  02a9  212500            	LD	HL,37
   563  02ac  19                	ADD	HL,DE
   564  02ad  c0                	RET	NZ
   565  02ae  3ede              CHANER:	LD	A,222
   566  02b0  cd0000            	CALL	EXTERR
   567  02b3  496e76616c696420  	DEFM	"Invalid channel"
              6368616e6e656c    
   568  02c2  00                	DEFB	0
   569                          ;
   570                          ;FIND1 - Look up file table.
   571                          ;   Inputs: E = channel
   572                          ;  Outputs: Z-flag set = file not opened
   573                          ;           If NZ, DE addresses FCB
   574                          ;                  HL points into table
   575                          ; Destroys: A,D,E,H,L,F
   576                          ;
   577  02c3  7b                FIND1:	LD	A,E
   578  02c4  e607              	AND	7
   579  02c6  87                	ADD	A,A
   580  02c7  5f                	LD	E,A
   581  02c8  1600              	LD	D,0
   582  02ca  215b08            	LD	HL,TABLE
   583  02cd  19                	ADD	HL,DE
   584  02ce  5e                	LD	E,(HL)
   585  02cf  23                	INC	HL
   586  02d0  56                	LD	D,(HL)
   587  02d1  7a                	LD	A,D
   588  02d2  b3                	OR	E
   589  02d3  c9                	RET
   590                          ;
   591                          ;SETUP - Set up File Control Block.
   592                          ;   Inputs: HL addresses filename
   593                          ;           Format  [A:]FILENAME[.EXT]
   594                          ;           Device defaults to current drive
   595                          ;           Extension defaults to .BBC
   596                          ;           A = fill character
   597                          ;  Outputs: HL updated
   598                          ;           A = terminator
   599                          ;           BC = 128
   600                          ; Destroys: A,B,C,H,L,F
   601                          ;
   602                          ;FCB FORMAT (36 BYTES TOTAL):
   603                          ; 0      0=SAME DISK, 1=DISK A, 2=DISK B (ETC.)
   604                          ; 1-8    FILENAME, PADDED WITH SPACES
   605                          ; 9-11   EXTENSION, PADDED WITH SPACES
   606                          ; 12     CURRENT EXTENT, SET TO ZERO
   607                          ; 32-35  CLEARED TO ZERO
   608                          ;
   609  02d4  3e20              SETUP0:	LD	A,' '
   610  02d6  d5                SETUP:	PUSH	DE
   611  02d7  e5                	PUSH	HL
   612  02d8  116500            	LD	DE,FCB+9
   613  02db  217f03            	LD	HL,BBC
   614  02de  010300            	LD	BC,3
   615  02e1  edb0              	LDIR
   616  02e3  217c00            	LD	HL,FCB+32
   617  02e6  0604              	LD	B,4
   618  02e8  71                SETUP1:	LD	(HL),C
   619  02e9  23                	INC	HL
   620  02ea  10fc              	DJNZ	SETUP1
   621  02ec  e1                	POP	HL
   622  02ed  4f                	LD	C,A
   623  02ee  af                	XOR	A
   624  02ef  12                	LD	(DE),A
   625  02f0  d1                	POP	DE
   626  02f1  cd7803            	CALL	SKIPSP
   627  02f4  fe22              	CP	'"'
   628  02f6  2027              	JR	NZ,SETUP2
   629  02f8  23                	INC	HL
   630  02f9  cd7803            	CALL	SKIPSP
   631  02fc  cd1f03            	CALL	SETUP2
   632  02ff  fe22              	CP	'"'
   633  0301  23                	INC	HL
   634  0302  2874              	JR	Z,SKIPSP
   635  0304  3efd              BADSTR:	LD	A,253
   636  0306  cd0000            	CALL	EXTERR
   637  0309  4261642073747269  	DEFM	"Bad string"
              6e67              
   638  0313  00                	DEFB	0
   639                          ;
   640  0314  7e                PARSE:	LD	A,(HL)
   641  0315  23                	INC	HL
   642  0316  fe60              	CP	'`'
   643  0318  d0                	RET	NC
   644  0319  fe3f              	CP	'?'
   645  031b  d8                	RET	C
   646  031c  ee40              	XOR	40H
   647  031e  c9                	RET
   648                          ;
   649  031f  d5                SETUP2:	PUSH	DE
   650  0320  23                	INC	HL
   651  0321  7e                	LD	A,(HL)
   652  0322  fe3a              	CP	':'
   653  0324  2b                	DEC	HL
   654  0325  78                	LD	A,B
   655  0326  2005              	JR	NZ,DEVICE
   656  0328  7e                	LD	A,(HL)		;DRIVE
   657  0329  e61f              	AND	31
   658  032b  23                	INC	HL
   659  032c  23                	INC	HL
   660  032d  115c00            DEVICE:	LD	DE,FCB
   661  0330  12                	LD	(DE),A
   662  0331  13                	INC	DE
   663  0332  0608              	LD	B,8
   664  0334  7e                COPYF:	LD	A,(HL)
   665  0335  fe2e              	CP	'.'
   666  0337  2822              	JR	Z,COPYF1
   667  0339  fe20              	CP	' '
   668  033b  281e              	JR	Z,COPYF1
   669  033d  fe0d              	CP	CR
   670  033f  281a              	JR	Z,COPYF1
   671  0341  fe3d              	CP	'='
   672  0343  2816              	JR	Z,COPYF1
   673  0345  fe22              	CP	'"'
   674  0347  2812              	JR	Z,COPYF1
   675  0349  0e3f              	LD	C,'?'
   676  034b  fe2a              	CP	'*'
   677  034d  280c              	JR	Z,COPYF1
   678  034f  0e20              	LD	C,' '
   679  0351  23                	INC	HL
   680  0352  fe7c              	CP	'|'
   681  0354  2006              	JR	NZ,COPYF2
   682  0356  cd1403            	CALL	PARSE
   683  0359  1804              	JR	COPYF0
   684  035b  79                COPYF1:	LD	A,C
   685  035c  cd4305            COPYF2:	CALL	UPPRC
   686  035f  12                COPYF0:	LD	(DE),A
   687  0360  13                	INC	DE
   688  0361  10d1              	DJNZ	COPYF
   689  0363  7e                COPYF3:	LD	A,(HL)
   690  0364  23                	INC	HL
   691  0365  fe2a              	CP	'*'
   692  0367  28fa              	JR	Z,COPYF3
   693  0369  fe2e              	CP	'.'
   694  036b  012003            	LD	BC,3*256+' '
   695  036e  116500            	LD	DE,FCB+9
   696  0371  28c1              	JR	Z,COPYF
   697  0373  2b                	DEC	HL
   698  0374  d1                	POP	DE
   699  0375  018000            	LD	BC,128
   700  0378  7e                SKIPSP:	LD	A,(HL)
   701  0379  fe20              	CP	' '
   702  037b  c0                	RET	NZ
   703  037c  23                	INC	HL
   704  037d  18f9              	JR	SKIPSP
   705                          ;
   706  037f  424243            BBC:	DEFM	"BBC"
   707                          ;
   708                          ;HEX - Read a hex string & convert to binary.
   709                          ;   Inputs: HL = text pointer
   710                          ;  Outputs: HL = updated text pointer
   711                          ;           DE = value
   712                          ;            A = terminator (spaces skipped)
   713                          ; Destroys: A,D,E,H,L,F
   714                          ;
   715  0382  110000            HEX:	LD	DE,0		;INITIALISE
   716  0385  cd7803            	CALL	SKIPSP
   717  0388  7e                HEX1:	LD	A,(HL)
   718  0389  cd4305            	CALL	UPPRC
   719  038c  fe30              	CP	'0'
   720  038e  38e8              	JR	C,SKIPSP
   721  0390  fe3a              	CP	'9'+1
   722  0392  380a              	JR	C,HEX2
   723  0394  fe41              	CP	'A'
   724  0396  38e0              	JR	C,SKIPSP
   725  0398  fe47              	CP	'F'+1
   726  039a  30dc              	JR	NC,SKIPSP
   727  039c  d607              	SUB	7
   728  039e  e60f              HEX2:	AND	0FH
   729  03a0  eb                	EX	DE,HL
   730  03a1  29                	ADD	HL,HL
   731  03a2  29                	ADD	HL,HL
   732  03a3  29                	ADD	HL,HL
   733  03a4  29                	ADD	HL,HL
   734  03a5  eb                	EX	DE,HL
   735  03a6  b3                	OR	E
   736  03a7  5f                	LD	E,A
   737  03a8  23                	INC	HL
   738  03a9  18dd              	JR	HEX1
   739                          ;
   740                          ;OSCLI - Process an "operating system" command
   741                          ;
   742  03ab  cd7803            OSCLI:	CALL	SKIPSP
   743  03ae  fe0d              	CP	CR
   744  03b0  c8                	RET	Z
   745  03b1  fe7c              	CP	'|'
   746  03b3  c8                	RET	Z
   747  03b4  fe2e              	CP	'.'
   748  03b6  ca8b04            	JP	Z,DOT		;*.
   749  03b9  eb                	EX	DE,HL
   750  03ba  216a05            	LD	HL,COMDS
   751  03bd  1a                OSCLI0:	LD	A,(DE)
   752  03be  cd4305            	CALL	UPPRC
   753  03c1  be                	CP	(HL)
   754  03c2  280b              	JR	Z,OSCLI2
   755  03c4  3875              	JR	C,HUH
   756  03c6  cb7e              OSCLI1:	BIT	7,(HL)
   757  03c8  23                	INC	HL
   758  03c9  28fb              	JR	Z,OSCLI1
   759  03cb  23                	INC	HL
   760  03cc  23                	INC	HL
   761  03cd  18ee              	JR	OSCLI0
   762                          ;
   763  03cf  d5                OSCLI2:	PUSH	DE
   764  03d0  13                OSCLI3:	INC	DE
   765  03d1  23                	INC	HL
   766  03d2  1a                	LD	A,(DE)
   767  03d3  cd4305            	CALL	UPPRC
   768  03d6  fe2e              	CP	'.'		;ABBREVIATED?
   769  03d8  280a              	JR	Z,OSCLI4
   770  03da  ae                	XOR	(HL)
   771  03db  28f3              	JR	Z,OSCLI3
   772  03dd  fe80              	CP	80H
   773  03df  2803              	JR	Z,OSCLI4
   774  03e1  d1                	POP	DE
   775  03e2  18e2              	JR	OSCLI1
   776                          ;
   777  03e4  f1                OSCLI4:	POP	AF
   778  03e5  13                	INC	DE
   779  03e6  cb7e              OSCLI5:	BIT	7,(HL)
   780  03e8  23                	INC	HL
   781  03e9  28fb              	JR	Z,OSCLI5
   782  03eb  7e                	LD	A,(HL)
   783  03ec  23                	INC	HL
   784  03ed  66                	LD	H,(HL)
   785  03ee  6f                	LD	L,A
   786  03ef  e5                	PUSH	HL
   787  03f0  eb                	EX	DE,HL
   788  03f1  c37803            	JP	SKIPSP
   789                          ;
   790                          ;
   791  03f4  cdd402            ERA:	CALL	SETUP0		;*ERA, *ERASE
   792  03f7  0e13              	LD	C,19
   793  03f9  1833              	JR	XEQ		;"DELETE"
   794                          ;
   795  03fb  0e0d              RES:	LD	C,13		;*RESET
   796  03fd  182f              	JR	XEQ		;"RESET"
   797                          ;
   798  03ff  cdd402            DRV:	CALL	SETUP0		;*DRIVE
   799  0402  3a5c00            	LD	A,(FCB)
   800  0405  3d                	DEC	A
   801  0406  fa3b04            	JP	M,HUH
   802  0409  5f                	LD	E,A
   803  040a  0e0e              	LD	C,14
   804  040c  1823              	JR	XEQ0
   805                          ;
   806  040e  cdd402            REN:	CALL	SETUP0		;*REN, *RENAME
   807  0411  fe3d              	CP	'='
   808  0413  2026              	JR	NZ,HUH
   809  0415  23                	INC	HL		;SKIP "="
   810  0416  e5                	PUSH	HL
   811  0417  cd4c04            	CALL	EXISTS
   812  041a  215c00            	LD	HL,FCB
   813  041d  116c00            	LD	DE,FCB+16
   814  0420  010c00            	LD	BC,12
   815  0423  edb0              	LDIR
   816  0425  e1                	POP	HL
   817  0426  cdd402            	CALL	SETUP0
   818  0429  cd7c02            	CALL	CHKAMB
   819  042c  0e17              	LD	C,23
   820  042e  115c00            XEQ:	LD	DE,FCB
   821  0431  7e                XEQ0:	LD	A,(HL)
   822  0432  fe0d              	CP	CR
   823  0434  2005              	JR	NZ,HUH
   824  0436  79                BDC:	LD	A,C
   825  0437  cd1002            	CALL	BDOS1
   826  043a  f0                	RET	P
   827  043b  3efe              HUH:	LD	A,254
   828  043d  cd0000            	CALL	EXTERR
   829  0440  42616420636f6d6d  	DEFM	"Bad command"
              616e64            
   830  044b  00                	DEFB	0
   831                          ;
   832  044c  218000            EXISTS:	LD	HL,DSKBUF
   833  044f  cd9a02            	CALL	SETDMA
   834  0452  115c00            	LD	DE,FCB
   835  0455  3e11              	LD	A,17
   836  0457  cd1002            	CALL	BDOS1		;SEARCH
   837  045a  3c                	INC	A
   838  045b  c8                	RET	Z
   839  045c  3ec4              	LD	A,196
   840  045e  cd0000            	CALL	EXTERR
   841  0461  46696c6520657869  	DEFM	"File exists"
              737473            
   842  046c  00                	DEFB	0
   843                          ;
   844  046d  cdd402            SAVLOD:	CALL	SETUP0		;PART OF *SAVE, *LOAD
   845  0470  cd8203            	CALL	HEX
   846  0473  fe2b              	CP	'+'
   847  0475  f5                	PUSH	AF
   848  0476  d5                	PUSH	DE
   849  0477  2001              	JR	NZ,SAVLO1
   850  0479  23                	INC	HL
   851  047a  cd8203            SAVLO1:	CALL	HEX
   852  047d  fe0d              	CP	CR
   853  047f  20ba              	JR	NZ,HUH
   854  0481  eb                	EX	DE,HL
   855  0482  d1                	POP	DE
   856  0483  f1                	POP	AF
   857  0484  c8                	RET	Z
   858  0485  b7                	OR	A
   859  0486  ed52              	SBC	HL,DE
   860  0488  c0                	RET	NZ
   861  0489  18b0              	JR	HUH
   862                          ;
   863  048b  23                DOT:	INC	HL
   864  048c  3e3f              DIR:	LD	A,'?'		;*DIR
   865  048e  cdd602            	CALL	SETUP
   866  0491  fe0d              	CP	CR
   867  0493  20a6              	JR	NZ,HUH
   868  0495  0e11              	LD	C,17
   869  0497  0604              DIR0:	LD	B,4
   870  0499  cd1606            DIR1:	CALL	LTRAP
   871  049c  115c00            	LD	DE,FCB
   872  049f  218000            	LD	HL,DSKBUF
   873  04a2  cd9a02            	CALL	SETDMA
   874  04a5  79                	LD	A,C
   875  04a6  cd1002            	CALL	BDOS1		;SEARCH DIRECTORY
   876  04a9  fa0000            	JP	M,CRLF
   877  04ac  0f                	RRCA
   878  04ad  0f                	RRCA
   879  04ae  0f                	RRCA
   880  04af  e660              	AND	60H
   881  04b1  5f                	LD	E,A
   882  04b2  1600              	LD	D,0
   883  04b4  218100            	LD	HL,DSKBUF+1
   884  04b7  19                	ADD	HL,DE
   885  04b8  e5                	PUSH	HL
   886  04b9  110800            	LD	DE,8
   887  04bc  19                	ADD	HL,DE
   888  04bd  5e                	LD	E,(HL)
   889  04be  23                	INC	HL
   890  04bf  cb7e              	BIT	7,(HL)		;SYSTEM FILE?
   891  04c1  e1                	POP	HL
   892  04c2  0e12              	LD	C,18
   893  04c4  20d3              	JR	NZ,DIR1
   894  04c6  c5                	PUSH	BC
   895  04c7  3a5c00            	LD	A,(FCB)
   896  04ca  3d                	DEC	A
   897  04cb  0e19              	LD	C,25
   898  04cd  fc3604            	CALL	M,BDC
   899  04d0  c641              	ADD	A,'A'
   900  04d2  cd9b06            	CALL	OSWRCH
   901  04d5  0608              	LD	B,8
   902  04d7  3e20              	LD	A,' '
   903  04d9  cb7b              	BIT	7,E		;READ ONLY?
   904  04db  2802              	JR	Z,DIR3
   905  04dd  3e2a              	LD	A,'*'
   906  04df  cdd105            DIR3:	CALL	CPTEXT
   907  04e2  0603              	LD	B,3
   908  04e4  3e20              	LD	A,' '
   909  04e6  cdd805            	CALL	SPTEXT
   910  04e9  c1                	POP	BC
   911  04ea  1005              	DJNZ	DIR2
   912  04ec  cd0000            	CALL	CRLF
   913  04ef  18a6              	JR	DIR0
   914                          ;
   915  04f1  c5                DIR2:	PUSH	BC
   916  04f2  0605              	LD	B,5
   917  04f4  3e20              PAD:	LD	A,' '
   918  04f6  cd9b06            	CALL	OSWRCH
   919  04f9  10f9              	DJNZ	PAD
   920  04fb  c1                	POP	BC
   921  04fc  189b              	JR	DIR1
   922                          ;
   923  04fe  cd8203            OPT:	CALL	HEX		;*OPT
   924  0501  7b                	LD	A,E
   925  0502  e603              	AND	3
   926  0504  326f08            SETOPT:	LD	(OPTVAL),A
   927  0507  c9                	RET
   928                          ;
   929  0508  af                RESET:	XOR	A
   930  0509  18f9              	JR	SETOPT
   931                          ;
   932  050b  3e01              EXEC:	LD	A,00000001B	;*EXEC
   933  050d  01                	DEFB	1		;SKIP 2 BYTES (LD BC)
   934  050e  3e02              SPOOL:	LD	A,00000010B	;*SPOOL
   935  0510  f5                	PUSH	AF
   936  0511  e5                	PUSH	HL
   937  0512  cd6300            	CALL	SESHUT		;STOP SPOOL/EXEC
   938  0515  e1                	POP	HL
   939  0516  c1                	POP	BC
   940  0517  7e                	LD	A,(HL)
   941  0518  fe0d              	CP	CR		;JUST SHUT?
   942  051a  c8                	RET	Z
   943  051b  3a6b08            	LD	A,(FLAGS)
   944  051e  b0                	OR	B
   945  051f  326b08            	LD	(FLAGS),A	;SPOOL/EXEC FLAG
   946  0522  1f                	RRA			;CARRY=1 FOR EXEC
   947  0523  cdea00            	CALL	OPENIT		;OPEN SPOOL/EXEC FILE
   948  0526  c8                	RET	Z		;DIR FULL / NOT FOUND
   949  0527  dde1              	POP	IX		;RETURN ADDRESS
   950  0529  2a0000            	LD	HL,(HIMEM)
   951  052c  b7                	OR	A
   952  052d  ed72              	SBC	HL,SP		;SP=HIMEM?
   953  052f  39                	ADD	HL,SP
   954  0530  200f              	JR	NZ,JPIX		;ABORT
   955  0532  015aff            	LD	BC,-FCBSIZ
   956  0535  09                	ADD	HL,BC		;HL=HL-FCBSIZ
   957  0536  220000            	LD	(HIMEM),HL	;NEW HIMEM
   958  0539  225b08            	LD	(TABLE),HL	;FCB/BUFFER
   959  053c  f9                	LD	SP,HL		;NEW SP
   960  053d  eb                	EX	DE,HL
   961  053e  cd2f01            	CALL	OPEN3		;FINISH OPEN OPERATION
   962  0541  dde9              JPIX:	JP	(IX)		;"RETURN"
   963                          ;
   964  0543  e67f              UPPRC:	AND	7FH
   965  0545  fe60              	CP	'`'
   966  0547  d8                	RET	C
   967  0548  e65f              	AND	5FH		;CONVERT TO UPPER CASE
   968  054a  c9                	RET
   969                          ;
   970  054b  0620              HELP:	LD	B,32
   971  054d  210000            	LD	HL,VERMSG
   972  0550  c3db05            	JP	PTEXT
   973                          ;
   974                          ;*ESC COMMAND
   975                          ;
   976  0553  7e                ESCCTL:	LD	A,(HL)
   977  0554  cd4305            	CALL	UPPRC		;**
   978  0557  fe4f              	CP	'O'
   979  0559  2001              	JR	NZ,ESCC1
   980  055b  23                	INC	HL
   981  055c  cd8203            ESCC1:	CALL	HEX
   982  055f  7b                	LD	A,E
   983  0560  b7                	OR	A
   984  0561  216b08            	LD	HL,FLAGS
   985  0564  cbb6              	RES	6,(HL)		;ENABLE ESCAPE
   986  0566  c8                	RET	Z
   987  0567  cbf6              	SET	6,(HL)		;DISABLE ESCAPE
   988  0569  c9                	RET
   989                          ;
   990                          ;
   991  056a  4259              COMDS:	DEFM	"BY"
   992  056c  c5                	DEFB	'E'+80H
   993  056d  0000              	DEFW	BYE
   994  056f  4449              	DEFM	"DI"
   995  0571  d2                	DEFB	'R'+80H
   996  0572  8c04              	DEFW	DIR
   997  0574  44524956          	DEFM	"DRIV"
   998  0578  c5                	DEFB	'E'+80H
   999  0579  ff03              	DEFW	DRV
  1000  057b  45524153          	DEFM	"ERAS"
  1001  057f  c5                	DEFB	'E'+80H
  1002  0580  f403              	DEFW	ERA
  1003  0582  4552              	DEFM	"ER"
  1004  0584  c1                	DEFB	'A'+80H
  1005  0585  f403              	DEFW	ERA
  1006  0587  4553              	DEFM	"ES"
  1007  0589  c3                	DEFB	'C'+80H
  1008  058a  5305              	DEFW	ESCCTL
  1009  058c  455845            	DEFM	"EXE"
  1010  058f  c3                	DEFB	'C'+80H
  1011  0590  0b05              	DEFW	EXEC
  1012  0592  48454c            	DEFM	"HEL"
  1013  0595  d0                	DEFB	'P'+80H
  1014  0596  4b05              	DEFW	HELP
  1015  0598  4c4f41            	DEFM	"LOA"
  1016  059b  c4                	DEFB	'D'+80H
  1017  059c  af00              	DEFW	STLOAD
  1018  059e  4f50              	DEFM	"OP"
  1019  05a0  d4                	DEFB	'T'+80H
  1020  05a1  fe04              	DEFW	OPT
  1021  05a3  515549            	DEFM	"QUI"
  1022  05a6  d4                	DEFB	'T'+80H
  1023  05a7  0000              	DEFW	BYE
  1024  05a9  52454e414d        	DEFM	"RENAM"
  1025  05ae  c5                	DEFB	'E'+80H
  1026  05af  0e04              	DEFW	REN
  1027  05b1  5245              	DEFM	"RE"
  1028  05b3  ce                	DEFB	'N'+80H
  1029  05b4  0e04              	DEFW	REN
  1030  05b6  52455345          	DEFM	"RESE"
  1031  05ba  d4                	DEFB	'T'+80H
  1032  05bb  fb03              	DEFW	RES
  1033  05bd  534156            	DEFM	"SAV"
  1034  05c0  c5                	DEFB	'E'+80H
  1035  05c1  0000              	DEFW	STSAVE
  1036  05c3  53504f4f          	DEFM	"SPOO"
  1037  05c7  cc                	DEFB	'L'+80H
  1038  05c8  0e05              	DEFW	SPOOL
  1039  05ca  545950            	DEFM	"TYP"
  1040  05cd  c5                	DEFB	'E'+80H
  1041  05ce  9000              	DEFW	TYPE
  1042  05d0  ff                	DEFB	0FFH
  1043                          ;
  1044                          ;PTEXT - Print text
  1045                          ;   Inputs: HL = address of text
  1046                          ;            B = number of characters to print
  1047                          ; Destroys: A,B,H,L,F
  1048                          ;
  1049  05d1  f5                CPTEXT:	PUSH	AF
  1050  05d2  3e3a              	LD	A,':'
  1051  05d4  cd9b06            	CALL	OSWRCH
  1052  05d7  f1                	POP	AF
  1053  05d8  cd9b06            SPTEXT:	CALL	OSWRCH
  1054  05db  7e                PTEXT:	LD	A,(HL)
  1055  05dc  e67f              	AND	7FH
  1056  05de  23                	INC	HL
  1057  05df  cd9b06            	CALL	OSWRCH
  1058  05e2  10f7              	DJNZ	PTEXT
  1059  05e4  c9                	RET
  1060                          ;
  1061                          ;OSINIT - Initialise RAM mapping etc.
  1062                          ;If BASIC is entered by BBCBASIC FILENAME then file
  1063                          ;FILENAME.BBC is automatically CHAINed.
  1064                          ;   Outputs: DE = initial value of HIMEM (top of RAM)
  1065                          ;            HL = initial value of PAGE (user program)
  1066                          ;            Z-flag reset indicates AUTO-RUN.
  1067                          ;  Destroys: A,B,C,D,E,H,L,F
  1068                          ;
  1069  05e5  0e2d              OSINIT:	LD	C,45		;*
  1070  05e7  1efe              	LD	E,254		;*
  1071  05e9  cd0500            	CALL	BDOS		;*
  1072  05ec  af                	XOR	A
  1073  05ed  0615              	LD	B,INILEN
  1074  05ef  215b08            	LD	HL,TABLE
  1075  05f2  77                CLRTAB:	LD	(HL),A		;CLEAR FILE TABLE ETC.
  1076  05f3  23                	INC	HL
  1077  05f4  10fc              	DJNZ	CLRTAB
  1078  05f6  110000            	LD	DE,ACCS
  1079  05f9  218000            	LD	HL,DSKBUF
  1080  05fc  4e                	LD	C,(HL)
  1081  05fd  23                	INC	HL
  1082  05fe  b9                	CP	C		;N.B. A=B=0
  1083  05ff  2802              	JR	Z,NOBOOT
  1084  0601  edb0              	LDIR			;COPY TO ACCS
  1085  0603  eb                NOBOOT:	EX	DE,HL
  1086  0604  360d              	LD	(HL),CR
  1087  0606  ed5b0600          	LD	DE,(6)		;DE = HIMEM
  1088  060a  5f                	LD	E,A		;PAGE BOUNDARY
  1089  060b  210000            	LD	HL,USER
  1090  060e  c9                	RET
  1091                          ;
  1092                          ;
  1093                          ;TRAP - Test ESCAPE flag & abort if set;
  1094                          ;       every 20th call, test for keypress.
  1095                          ; Destroys: A,H,L,F
  1096                          ;
  1097                          ;LTRAP - Test ESCAPE flag & abort if set.
  1098                          ; Destroys: A,F
  1099                          ;
  1100  060f  215a08            TRAP:	LD	HL,TRPCNT
  1101  0612  35                	DEC	(HL)
  1102  0613  cc2306            	CALL	Z,TEST20	;TEST KEYBOARD
  1103  0616  3a6b08            LTRAP:	LD	A,(FLAGS)	;ESCAPE FLAG
  1104  0619  b7                	OR	A		;TEST
  1105  061a  f0                	RET	P
  1106  061b  216b08            ABORT:	LD	HL,FLAGS	;ACKNOWLEDGE
  1107  061e  cbbe              	RES	7,(HL)		;ESCAPE
  1108  0620  c30000            	JP	ESCAPE		;AND ABORT
  1109                          ;
  1110                          ;TEST - Sample for ESCape & CTRL/S. If ESCape
  1111                          ;       pressed set ESCAPE flag & return.
  1112                          ; Destroys: A,F
  1113                          ;
  1114  0623  3614              TEST20:	LD	(HL),20
  1115  0625  d5                TEST:	PUSH	DE
  1116  0626  3e06              	LD	A,6
  1117  0628  1eff              	LD	E,0FFH
  1118  062a  cd2702            	CALL	BDOS0
  1119  062d  d1                	POP	DE
  1120  062e  b7                	OR	A
  1121  062f  c8                	RET	Z
  1122  0630  fe13              	CP	'S' & 1FH	;PAUSE DISPLAY?
  1123  0632  281e              	JR	Z,OSRDCH
  1124  0634  fe1b              	CP	ESC
  1125  0636  2857              	JR	Z,ESCSET
  1126  0638  326c08            	LD	(INKEY),A
  1127  063b  c9                	RET
  1128                          ;
  1129                          ;OSRDCH - Read from the current input stream (keyboard).
  1130                          ;  Outputs: A = character
  1131                          ; Destroys: A,F
  1132                          ;
  1133  063c  dd46f4            KEYGET:	LD	B,(IX-12)	;SCREEN WIDTH
  1134  063f  cd5206            	CALL	OSRDCH
  1135  0642  fe7f              	CP	DEL
  1136  0644  2809              	JR	Z,KEYDEL
  1137  0646  fee0              	CP	224
  1138  0648  c0                	RET	NZ
  1139  0649  cd5206            	CALL	OSRDCH
  1140  064c  d641              	SUB	65
  1141  064e  c9                	RET
  1142                          ;
  1143  064f  3e08              KEYDEL:	LD	A,BS
  1144  0651  c9                	RET
  1145                          ;
  1146  0652  3a6b08            OSRDCH:	LD	A,(FLAGS)
  1147  0655  1f                	RRA			;*EXEC ACTIVE?
  1148  0656  380a              	JR	C,EXECIN
  1149  0658  e5                	PUSH	HL
  1150  0659  ed62              	SBC	HL,HL		;HL=0
  1151  065b  cd7a06            	CALL	OSKEY
  1152  065e  e1                	POP	HL
  1153  065f  d8                	RET	C
  1154  0660  18f0              	JR	OSRDCH
  1155                          ;
  1156                          ;EXECIN - Read byte from EXEC file
  1157                          ;  Outputs: A = byte read
  1158                          ; Destroys: A,F
  1159                          ;
  1160  0662  c5                EXECIN:	PUSH	BC		;SAVE REGISTERS
  1161  0663  d5                	PUSH	DE
  1162  0664  e5                	PUSH	HL
  1163  0665  1e08              	LD	E,8		;SPOOL/EXEC CHANNEL
  1164  0667  216b08            	LD	HL,FLAGS
  1165  066a  cb86              	RES	0,(HL)
  1166  066c  cd6201            	CALL	OSBGET
  1167  066f  cbc6              	SET	0,(HL)
  1168  0671  f5                	PUSH	AF
  1169  0672  dc6300            	CALL	C,SESHUT	;END EXEC IF EOF
  1170  0675  f1                	POP	AF
  1171  0676  e1                	POP	HL		;RESTORE REGISTERS
  1172  0677  d1                	POP	DE
  1173  0678  c1                	POP	BC
  1174  0679  c9                	RET
  1175                          ;
  1176                          ;
  1177                          ;OSKEY - Read key with time-limit, test for ESCape.
  1178                          ;Main function is carried out in user patch.
  1179                          ;   Inputs: HL = time limit (centiseconds)
  1180                          ;  Outputs: Carry reset if time-out
  1181                          ;           If carry set A = character
  1182                          ; Destroys: A,H,L,F
  1183                          ;
  1184  067a  e5                OSKEY:	PUSH	HL
  1185  067b  216c08            	LD	HL,INKEY
  1186  067e  7e                	LD	A,(HL)
  1187  067f  3600              	LD	(HL),0
  1188  0681  e1                	POP	HL
  1189  0682  b7                	OR	A
  1190  0683  37                	SCF
  1191  0684  c0                	RET	NZ
  1192  0685  d5                	PUSH	DE
  1193  0686  cd0000            	CALL	GETKEY
  1194  0689  d1                	POP	DE
  1195  068a  d0                	RET	NC
  1196  068b  fe1b              	CP	ESC
  1197  068d  37                	SCF
  1198  068e  c0                	RET	NZ
  1199  068f  e5                ESCSET:	PUSH	HL
  1200  0690  216b08            	LD	HL,FLAGS
  1201  0693  cb76              	BIT	6,(HL)		;ESC DISABLED?
  1202  0695  2002              	JR	NZ,ESCDIS
  1203  0697  cbfe              	SET	7,(HL)		;SET ESCAPE FLAG
  1204  0699  e1                ESCDIS:	POP	HL
  1205  069a  c9                	RET
  1206                          ;
  1207                          ;OSWRCH - Write a character to console output.
  1208                          ;   Inputs: A = character.
  1209                          ; Destroys: Nothing
  1210                          ;
  1211  069b  f5                OSWRCH:	PUSH	AF
  1212  069c  d5                	PUSH	DE
  1213  069d  e5                	PUSH	HL
  1214  069e  5f                	LD	E,A
  1215  069f  cd2506            	CALL	TEST
  1216  06a2  cda906            	CALL	EDPUT
  1217  06a5  e1                	POP	HL
  1218  06a6  d1                	POP	DE
  1219  06a7  f1                	POP	AF
  1220  06a8  c9                	RET
  1221                          ;
  1222  06a9  3a6b08            EDPUT:	LD	A,(FLAGS)
  1223  06ac  cb5f              	BIT	3,A
  1224  06ae  2810              	JR	Z,WRCH
  1225  06b0  7b                	LD	A,E
  1226  06b1  fe20              	CP	' '
  1227  06b3  d8                	RET	C
  1228  06b4  2a6d08            	LD	HL,(EDPTR)
  1229  06b7  73                	LD	(HL),E
  1230  06b8  2c                	INC	L
  1231  06b9  c8                	RET	Z
  1232  06ba  226d08            	LD	(EDPTR),HL
  1233  06bd  c9                	RET
  1234                          ;
  1235  06be  1e3e              PROMPT:	LD	E,'>'
  1236  06c0  3a6f08            WRCH:	LD	A,(OPTVAL)	;FAST ENTRY
  1237  06c3  c603              	ADD	A,3
  1238  06c5  fe03              	CP	3
  1239  06c7  2007              	JR	NZ,WRCH1
  1240  06c9  83                	ADD	A,E
  1241  06ca  3e02              	LD	A,2
  1242  06cc  3802              	JR	C,WRCH1
  1243  06ce  3e06              	LD	A,6
  1244  06d0  cd2702            WRCH1:	CALL	BDOS0
  1245  06d3  216b08            	LD	HL,FLAGS
  1246  06d6  cb56              	BIT	2,(HL)
  1247  06d8  3e05              	LD	A,5		;PRINTER O/P
  1248  06da  c42702            	CALL	NZ,BDOS0
  1249  06dd  cb4e              	BIT	1,(HL)		;SPOOLING?
  1250  06df  c8                	RET	Z
  1251  06e0  cb8e              	RES	1,(HL)
  1252  06e2  7b                	LD	A,E		;BYTE TO WRITE
  1253  06e3  1e08              	LD	E,8		;SPOOL/EXEC CHANNEL
  1254  06e5  c5                	PUSH	BC
  1255  06e6  cd4501            	CALL	OSBPUT
  1256  06e9  c1                	POP	BC
  1257  06ea  cbce              	SET	1,(HL)
  1258  06ec  c9                	RET
  1259                          ;
  1260  06ed  010000            TOGGLE:	LD	BC,0
  1261  06f0  3a6b08            	LD	A,(FLAGS)
  1262  06f3  ee04              	XOR	00000100B
  1263  06f5  326b08            	LD	(FLAGS),A
  1264  06f8  c9                	RET
  1265                          ;
  1266  06f9  3a6b08            INSERT:	LD	A,(FLAGS)
  1267  06fc  ee10              	XOR	00010000B
  1268  06fe  326b08            	LD	(FLAGS),A
  1269  0701  c9                	RET
  1270                          ;
  1271                          ;OSLINE - Read/edit a complete line, terminated by CR.
  1272                          ;   Inputs: HL addresses destination buffer.
  1273                          ;           (L=0)
  1274                          ;  Outputs: Buffer filled, terminated by CR.
  1275                          ;           A=0.
  1276                          ; Destroys: A,B,C,D,E,H,L,F
  1277                          ;
  1278  0702  dd210002          OSLINE:	LD	IX,200H
  1279  0706  3a6b08            	LD	A,(FLAGS)
  1280  0709  cb5f              	BIT	3,A		;EDIT MODE?
  1281  070b  2809              	JR	Z,OSLIN1
  1282  070d  cb9f              	RES	3,A
  1283  070f  326b08            	LD	(FLAGS),A
  1284  0712  2a6d08            	LD	HL,(EDPTR)
  1285  0715  bd                	CP	L
  1286  0716  3e0d              OSLIN1:	LD	A,CR
  1287  0718  77                	LD	(HL),A
  1288  0719  c49b06            	CALL	NZ,OSWRCH
  1289  071c  2e00              	LD	L,0
  1290  071e  4d                	LD	C,L		;REPEAT FLAG
  1291  071f  2820              	JR	Z,OSWAIT	;SUPPRESS UNWANTED SPACE
  1292  0721  0600              UPDATE:	LD	B,0
  1293  0723  7e                UPD1:	LD	A,(HL)
  1294  0724  04                	INC	B
  1295  0725  23                	INC	HL
  1296  0726  fe0d              	CP	CR
  1297  0728  f5                	PUSH	AF
  1298  0729  e5                	PUSH	HL
  1299  072a  5f                	LD	E,A
  1300  072b  c4c006            	CALL	NZ,WRCH		;FAST WRCH
  1301  072e  e1                	POP	HL
  1302  072f  f1                	POP	AF
  1303  0730  20f1              	JR	NZ,UPD1
  1304  0732  3e20              	LD	A,' '
  1305  0734  cd9b06            	CALL	OSWRCH
  1306  0737  1e08              	LD	E,BS
  1307  0739  e5                UPD2:	PUSH	HL
  1308  073a  cdc006            	CALL	WRCH		;FAST WRCH
  1309  073d  e1                	POP	HL
  1310  073e  2b                	DEC	HL
  1311  073f  10f8              	DJNZ	UPD2
  1312  0741  79                OSWAIT:	LD	A,C
  1313  0742  05                	DEC	B
  1314  0743  2801              	JR	Z,LIMIT
  1315  0745  b7                	OR	A		;REPEAT COMMAND?
  1316  0746  cc3c06            LIMIT:	CALL	Z,KEYGET	;READ KEYBOARD
  1317  0749  4f                	LD	C,A		;SAVE FOR REPEAT
  1318  074a  114107            	LD	DE,OSWAIT	;RETURN ADDRESS
  1319  074d  d5                	PUSH	DE
  1320  074e  3a6b08            	LD	A,(FLAGS)
  1321  0751  b7                	OR	A		;TEST FOR ESCAPE
  1322  0752  79                	LD	A,C
  1323  0753  faa207            	JP	M,OSEXIT
  1324  0756  fe10              	CP	'P' & 1FH
  1325  0758  caed06            	JP	Z,TOGGLE
  1326  075b  ddbef5            	CP	(IX-11)		;CURSOR UP     (IX-11)
  1327  075e  caee07            	JP	Z,LEFT
  1328  0761  ddbef6            	CP	(IX-10)		;CURSOR DOWN   (IX-10)
  1329  0764  ca3408            	JP	Z,RIGHT
  1330  0767  0600              	LD	B,0
  1331  0769  ddbefb            	CP	(IX-5)		;CLEAR LEFT    (IX-5)
  1332  076c  287f              	JR	Z,BACK
  1333  076e  ddbef7            	CP	(IX-9)		;START OF LINE (IX-9)
  1334  0771  287b              	JR	Z,LEFT
  1335  0773  ddbef8            	CP	(IX-8)		;END OF LINE   (IX-8)
  1336  0776  ca3408            	JP	Z,RIGHT
  1337  0779  ddbef9            	CP	(IX-7)		;CLEAR RIGHT   (IX-7)
  1338  077c  287b              	JR	Z,DELETE
  1339  077e  0e00              	LD	C,0		;INHIBIT REPEAT
  1340  0780  ddbeff            	CP	(IX-1)		;INSERT / OVR  (IX-1)
  1341  0783  caf906            	JP	Z,INSERT
  1342  0786  ddbefa            	CP	(IX-6)		;DELETE LEFT   (IX-6)
  1343  0789  2862              	JR	Z,BACK
  1344  078b  ddbefc            	CP	(IX-4)		;CURSOR LEFT   (IX-4)
  1345  078e  285e              	JR	Z,LEFT
  1346  0790  ddbefe            	CP	(IX-2)		;DELETE RIGHT  (IX-2)
  1347  0793  2864              	JR	Z,DELETE
  1348  0795  ddbefd            	CP	(IX-3)		;CURSOR RIGHT  (IX-3)
  1349  0798  ca3408            	JP	Z,RIGHT
  1350  079b  fe20              	CP	' '		;PRINTING CHARACTER
  1351  079d  306e              	JR	NC,SAVECH
  1352  079f  fe0d              	CP	CR		;ENTER LINE
  1353  07a1  c0                	RET	NZ
  1354  07a2  7e                OSEXIT:	LD	A,(HL)
  1355  07a3  cd9b06            	CALL	OSWRCH		;WRITE REST OF LINE
  1356  07a6  23                	INC	HL
  1357  07a7  d60d              	SUB	CR
  1358  07a9  20f7              	JR	NZ,OSEXIT
  1359  07ab  d1                	POP	DE		;DITCH RETURN ADDRESS
  1360  07ac  b9                	CP	C
  1361  07ad  c21b06            	JP	NZ,ABORT	;ESCAPE
  1362  07b0  3e0a              	LD	A,LF
  1363  07b2  cd9b06            	CALL	OSWRCH
  1364  07b5  af                	XOR	A
  1365  07b6  6f                	LD	L,A
  1366  07b7  226d08            	LD	(EDPTR),HL
  1367  07ba  ed5b0000          	LD	DE,(CURLIN)
  1368  07be  ba                	CP	D
  1369  07bf  c0                	RET	NZ
  1370  07c0  bb                	CP	E
  1371  07c1  c0                	RET	NZ
  1372  07c2  ed5b0000          	LD	DE,(AUTONO)
  1373  07c6  ba                	CP	D
  1374  07c7  c0                	RET	NZ
  1375  07c8  bb                	CP	E
  1376  07c9  c0                	RET	NZ
  1377  07ca  115208            	LD	DE,EDITST
  1378  07cd  0604              	LD	B,4
  1379  07cf  1a                CMPARE:	LD	A,(DE)
  1380  07d0  be                	CP	(HL)
  1381  07d1  3e00              	LD	A,0
  1382  07d3  c0                	RET	NZ
  1383  07d4  23                	INC	HL
  1384  07d5  13                	INC	DE
  1385  07d6  7e                	LD	A,(HL)
  1386  07d7  fe2e              	CP	'.'
  1387  07d9  2802              	JR	Z,ABBR
  1388  07db  10f2              	DJNZ	CMPARE
  1389  07dd  af                ABBR:	XOR	A
  1390  07de  47                	LD	B,A
  1391  07df  4d                	LD	C,L
  1392  07e0  6f                	LD	L,A
  1393  07e1  115608            	LD	DE,LISTST
  1394  07e4  eb                	EX	DE,HL
  1395  07e5  edb0              	LDIR
  1396  07e7  216b08            	LD	HL,FLAGS
  1397  07ea  cbde              	SET	3,(HL)
  1398  07ec  c9                	RET
  1399                          ;
  1400  07ed  37                BACK:	SCF			;DELETE LEFT
  1401  07ee  2c                LEFT:	INC	L		;CURSOR LEFT
  1402  07ef  2d                	DEC	L
  1403  07f0  285d              	JR	Z,STOP
  1404  07f2  3e08              	LD	A,BS
  1405  07f4  cd9b06            	CALL	OSWRCH
  1406  07f7  2d                	DEC	L
  1407  07f8  d0                	RET	NC
  1408  07f9  7e                DELETE:	LD	A,(HL)		;DELETE RIGHT
  1409  07fa  fe0d              	CP	CR
  1410  07fc  2851              	JR	Z,STOP
  1411  07fe  54                	LD	D,H
  1412  07ff  5d                	LD	E,L
  1413  0800  13                DEL1:	INC	DE
  1414  0801  1a                	LD	A,(DE)
  1415  0802  1b                	DEC	DE
  1416  0803  12                	LD	(DE),A
  1417  0804  13                	INC	DE
  1418  0805  fe0d              	CP	CR
  1419  0807  20f7              	JR	NZ,DEL1
  1420  0809  d1                DEL2:	POP	DE		;DITCH
  1421  080a  c32107            	JP	UPDATE
  1422                          ;
  1423  080d  57                SAVECH:	LD	D,A
  1424  080e  3a6b08            	LD	A,(FLAGS)
  1425  0811  e610              	AND	00010000B
  1426  0813  7a                	LD	A,D
  1427  0814  2023              	JR	NZ,RIGHT1
  1428  0816  57                	LD	D,A
  1429  0817  3e0d              	LD	A,CR		;INSERT SPACE
  1430  0819  be                	CP	(HL)
  1431  081a  7a                	LD	A,D
  1432  081b  281c              	JR	Z,RIGHT1
  1433  081d  54                	LD	D,H
  1434  081e  1efe              	LD	E,254
  1435  0820  f5                	PUSH	AF
  1436  0821  13                INS1:	INC	DE
  1437  0822  12                	LD	(DE),A
  1438  0823  1b                	DEC	DE
  1439  0824  7b                	LD	A,E
  1440  0825  bd                	CP	L
  1441  0826  1b                	DEC	DE
  1442  0827  1a                	LD	A,(DE)
  1443  0828  20f7              	JR	NZ,INS1
  1444  082a  f1                	POP	AF
  1445  082b  77                	LD	(HL),A
  1446  082c  2c                	INC	L
  1447  082d  2818              	JR	Z,WONTGO
  1448  082f  cd9b06            	CALL	OSWRCH
  1449  0832  18d5              	JR	DEL2
  1450                          ;
  1451  0834  7e                RIGHT:	LD	A,(HL)		;CURSOR RIGHT
  1452  0835  fe0d              	CP	CR
  1453  0837  2816              	JR	Z,STOP
  1454  0839  56                RIGHT1:	LD	D,(HL)		;PRINTING CHARACTER
  1455  083a  77                	LD	(HL),A
  1456  083b  2c                	INC	L
  1457  083c  2809              	JR	Z,WONTGO	;LINE TOO LONG
  1458  083e  cd9b06            	CALL	OSWRCH
  1459  0841  3e0d              	LD	A,CR
  1460  0843  ba                	CP	D
  1461  0844  c0                	RET	NZ
  1462  0845  77                	LD	(HL),A
  1463  0846  c9                	RET
  1464                          ;
  1465  0847  2d                WONTGO:	DEC	L
  1466  0848  360d              	LD	(HL),CR
  1467  084a  3e07              	LD	A,BEL
  1468  084c  cd9b06            	CALL	OSWRCH		;BEEP!
  1469  084f  0e00              STOP:	LD	C,0		;STOP REPEAT
  1470  0851  c9                	RET
  1471                          ;
  1472                          ;
  1473  0852  45444954          EDITST:	DEFM	"EDIT"
  1474  0856  4c495354          LISTST:	DEFM	"LIST"
  1475                          ;
  1476                          BEL	EQU	7
  1477                          BS	EQU	8
  1478                          HT	EQU	9
  1479                          LF	EQU	0AH
  1480                          VT	EQU	0BH
  1481                          CR	EQU	0DH
  1482                          ESC	EQU	1BH
  1483                          DEL	EQU	7FH
  1484                          ;
  1485                          BDOS	EQU	5
  1486                          ;
  1487                          FCB	EQU	5CH
  1488                          DSKBUF	EQU	80H
  1489                          ;
  1490                          FCBSIZ	EQU	128+36+2
  1491                          ;
  1492  085a  0a                TRPCNT:	DEFB	10
  1493  085b  0000000000000000  TABLE:	DEFS	16		;FILE BLOCK POINTERS
              0000000000000000  
  1494  086b  00                FLAGS:	DEFB	0
  1495  086c  00                INKEY:	DEFB	0
  1496  086d  0000              EDPTR:	DEFW	0
  1497  086f  00                OPTVAL:	DEFB	0
  1498                          INILEN	EQU	$-TABLE
  1499                          ;
  1500                          FIN:	DEFS 	0
  1501                          
